name: VPS Free Discord Bot

on:
  workflow_dispatch:

jobs:
  run-vpsfree:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install python3-pip (skip if exists)
        run: |
          if ! command -v pip3 &> /dev/null; then
            sudo apt update
            sudo apt install -y python3-pip
          else
            echo "‚úÖ python3-pip ƒë√£ c√†i, b·ªè qua."
          fi

      - name: Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          RUN apt update
          RUN apt install -y tmate
          EOF

      - name: Build Docker image (skip if exists)
        run: |
          if ! docker image inspect ubuntu-22.04-with-tmate >/dev/null 2>&1; then
            docker build -t ubuntu-22.04-with-tmate .
          else
            echo "‚úÖ Docker image ƒë√£ t·ªìn t·∫°i, b·ªè qua."
          fi

      - name: Download vpsfree.py
        run: |
          wget -O vpsfree.py https://raw.githubusercontent.com/KingSpam9989/KingSever/refs/heads/main/vpsfree.py
          echo "‚úÖ vpsfree.py ƒë√£ t·∫£i xong."
      - name: Install Python packages (skip if installed)
        run: |
          pip3 list | grep -q discord || pip3 install discord docker


      - name: Run VPS Discord Bot (6h) & Backup database.txt
        run: |
          # Ch·∫°y bot t·ªëi ƒëa 6 ti·∫øng
          timeout 6h python3 vpsfree.py

          # Backup database.txt n·∫øu c√≥
          if [ -f database.txt ]; then
            echo "üì¶ L∆∞u database.txt v√†o repo KingSever..."
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git clone https://x-access-token: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@github.com/KingSpam9989/KingSever.git temp_repo
            cp database.txt temp_repo/
            cd temp_repo
            git add database.txt
            git commit -m "Auto backup database.txt [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "‚ö†Ô∏è Kh√¥ng c√≥ thay ƒë·ªïi m·ªõi."
            git push
            cd ..
            rm -rf temp_repo
          else
            echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y database.txt, b·ªè qua backup."
          fi
